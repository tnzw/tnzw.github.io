def test_arrayview():
  # repr
  a = arrayview(b'01234567'); assert_equal(repr(a[:]), "arrayview(b'01234567', slice(0, 8, 1))")
  a = arrayview(bytearray(b'01234567')); assert_equal(repr(a), "arrayview(bytearray(b'01234567'), slice(0, None, 1))")
  a = arrayview(bytearray(b'01234567')); assert_equal(repr(a[:]), "arrayview(bytearray(b'01234567'), slice(0, 8, 1))")
  a = arrayview('01234567'); assert_equal(repr(a[:]), "arrayview('01234567', slice(0, 8, 1))")

  # __iter__
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(_ for _ in a), b"01234567")
  a = arrayview(bytearray(b"01234567"), slice(1, -1)); assert_equal(bytes(_ for _ in a), b"01234567"[1:-1])

  # __getitem__ index
  assert_equal(arrayview(bytearray(b"01234567"))[0], 0x30)
  assert_equal(arrayview(bytearray(b"01234567"))[7], 0x37)
  assert_equal(arrayview(bytearray(b"01234567"))[-8], 0x30)
  assert_equal(bytes(arrayview(bytearray(b"01234567"))[1:-1][1:-1]), b"01234567"[1:-1][1:-1])
  assert_raise(IndexError, lambda: arrayview(bytearray(b"01234567"))[8])
  assert_raise(IndexError, lambda: arrayview(bytearray(b"01234567"))[-9])
  #assert_equal(b"01234567"[arrayview(bytearray(b"01234567"))._trans_key(slice( 0, None, -1), error=True).start], 0x30)
  #assert_equal(b"01234567"[arrayview(bytearray(b"01234567"))._trans_key(slice( 7,    6, -1), error=True).start], 0x37)
  #assert_equal(b"01234567"[arrayview(bytearray(b"01234567"))._trans_key(slice(-8,   -9, -1), error=True).start], 0x30)
  #assert_raise(IndexError, lambda: b"01234567"[arrayview(bytearray(b"01234567"))._trans_key(slice( 8,   7, -1), error=True).start])
  #assert_raise(IndexError, lambda: b"01234567"[arrayview(bytearray(b"01234567"))._trans_key(slice(-9, -10, -1), error=True).start])
  assert_raise(IndexError, lambda: arrayview(bytearray(b"01234567"), slice(1, 3, 1))[2])
  assert_raise(IndexError, lambda: arrayview(bytearray(b"01234567"), slice(2, 0, -1))[2])
  #assert_raise(IndexError, lambda: arrayview(bytearray(b"01234567"), slice(1, 3, 1))._trans_key(slice(2, 1, -1), error=True))
  #assert_raise(IndexError, lambda: arrayview(bytearray(b"01234567"), slice(3, 1, -1))._trans_key(slice(2, 1, -1), error=True))

  # __getitem__ slice
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[:]      ), b"01234567"[:]      )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[1:]     ), b"01234567"[1:]     )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[1:-1]   ), b"01234567"[1:-1]   )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[::2]    ), b"01234567"[::2]    )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[1::2]   ), b"01234567"[1::2]   )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[1:-1:2] ), b"01234567"[1:-1:2] )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[::-1]   ), b"01234567"[::-1]   )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[-2::-1] ), b"01234567"[-2::-1] )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[-2:0:-1]), b"01234567"[-2:0:-1])
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[::-2]   ), b"01234567"[::-2]   )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[-2::-2] ), b"01234567"[-2::-2] )
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[-2:0:-2]), b"01234567"[-2:0:-2])
  a = arrayview(bytearray(b"01234567")); assert_equal(bytes(a[-10:10] ), b"01234567"[-10:10] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[:]      ), b"0246"[:]      )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[1:]     ), b"0246"[1:]     )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[1:-1]   ), b"0246"[1:-1]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[::2]    ), b"0246"[::2]    )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[1::2]   ), b"0246"[1::2]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[1:-1:2] ), b"0246"[1:-1:2] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[::-1]   ), b"0246"[::-1]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[-2::-1] ), b"0246"[-2::-1] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[-2:0:-1]), b"0246"[-2:0:-1])
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[::-2]   ), b"0246"[::-2]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[-2::-2] ), b"0246"[-2::-2] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, 2)); assert_equal(bytes(a[-2:0:-2]), b"0246"[-2:0:-2])
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[:]      ), b"135"[:]      )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[1:]     ), b"135"[1:]     )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[1:-1]   ), b"135"[1:-1]   )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[::2]    ), b"135"[::2]    )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[1::2]   ), b"135"[1::2]   )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[1:-1:2] ), b"135"[1:-1:2] )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[::-1]   ), b"135"[::-1]   )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[-2::-1] ), b"135"[-2::-1] )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[-2:0:-1]), b"135"[-2:0:-1])
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[::-2]   ), b"135"[::-2]   )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[-2::-2] ), b"135"[-2::-2] )
  a = arrayview(bytearray(b"01234567"), slice(1, -2, 2)); assert_equal(bytes(a[-2:0:-2]), b"135"[-2:0:-2])
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[:]      ), b"76543210"[:]      )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[1:]     ), b"76543210"[1:]     )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[1:-1]   ), b"76543210"[1:-1]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[::2]    ), b"76543210"[::2]    )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[1::2]   ), b"76543210"[1::2]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[1:-1:2] ), b"76543210"[1:-1:2] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[::-1]   ), b"76543210"[::-1]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[-2::-1] ), b"76543210"[-2::-1] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[-2:0:-1]), b"76543210"[-2:0:-1])
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[::-2]   ), b"76543210"[::-2]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[-2::-2] ), b"76543210"[-2::-2] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -1)); assert_equal(bytes(a[-2:0:-2]), b"76543210"[-2:0:-2])
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[:]      ), b"7531"[:]      )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[1:]     ), b"7531"[1:]     )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[1:-1]   ), b"7531"[1:-1]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[::2]    ), b"7531"[::2]    )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[1::2]   ), b"7531"[1::2]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[1:-1:2] ), b"7531"[1:-1:2] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[::-1]   ), b"7531"[::-1]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[-2::-1] ), b"7531"[-2::-1] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[-2:0:-1]), b"7531"[-2:0:-1])
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[::-2]   ), b"7531"[::-2]   )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[-2::-2] ), b"7531"[-2::-2] )
  a = arrayview(bytearray(b"01234567"), slice(None, None, -2)); assert_equal(bytes(a[-2:0:-2]), b"7531"[-2:0:-2])
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[:]      ), b"642"[:]      )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[1:]     ), b"642"[1:]     )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[1:-1]   ), b"642"[1:-1]   )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[::2]    ), b"642"[::2]    )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[1::2]   ), b"642"[1::2]   )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[1:-1:2] ), b"642"[1:-1:2] )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[::-1]   ), b"642"[::-1]   )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[-2::-1] ), b"642"[-2::-1] )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[-2:0:-1]), b"642"[-2:0:-1])
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[::-2]   ), b"642"[::-2]   )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[-2::-2] ), b"642"[-2::-2] )
  a = arrayview(bytearray(b"01234567"), slice(-2, 1, -2)); assert_equal(bytes(a[-2:0:-2]), b"642"[-2:0:-2])

def test_arrayview__setitem():
  def setitem(o, k, v): o[k] = v
  a = arrayview(bytearray(b"01234567"))
  assert_raise(ValueError, lambda: setitem(a, slice(None), b"89"))
  assert_equal(bytes(a), b"01234567")
  assert_raise(ValueError, lambda: setitem(a, slice(None), b"987654321"))
  assert_equal(bytes(a), b"01234567")
  assert_raise(ValueError, lambda: setitem(a, slice(0, 9), b"987654321"))
  assert_equal(bytes(a), b"01234567")
  a[:] = b"98765432"
  assert_equal(bytes(a), b"98765432")
  a[0:1] = b'1'
  assert_equal(bytes(a), b"18765432")

def test_arrayview__container():
  obj = bytearray(b"01234567")
  a = arrayview(obj)
  b = arrayview(a, slice(1, -1))
  assert_equal(bytes(a), b"01234567")
  assert_equal(bytes(b), b"123456")
  assert_equal(type(a.obj), bytearray)
  assert_equal(type(b.obj), bytearray)
